---
title: "Using a model to explore the consequences of change"
---

## Introduction

Mizer is a tool that can be used to simulate a dynamic size spectrum in an marine ecosystem, subject to changes through time, such as fishing pressure. Multiple interacting species and fishing gears can be defined allowing for a range of fisheries management strategy scenarios, and their ecosystem impacts, to be tested.

Below we explore some examples of what can be done using a previously calibrated Mizer model. We will use the mizerHowTo package which contains some handy functions for this example.

```{r set-up, echo = F,message=F, warning=F}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
remotes::install_github("sizespectrum/mizerHowTo")
library(mizerHowTo)
library(tidyverse)
source("helper_functions.R")

```

In the previous tutorials we have been focused on the steady state. Now we are ready to make changes through time by forcing the model away from its steady state. For this example, will start with the toothfish model but as always you can you your own model or the curonian lagoon for the exercises.

### Fishing through time

In the previous tutorial, we examined a simple longline fishery that consists of targeting a single species (toothfish, here referred to as *D.ele*). However, all of the parameters for fishing were fixed through time. Mizer can also be used to carry out projections with changes in fishing effort.

We will start by reading in a time series of catch and effort.

```{r, code_folding=TRUE}
# read in model sim object
sim <- readRDS("toothfish/params10.RDS")
params <- sim@params

# read in fishing data (note: these are not really correct values, they are only for illustration in this example) 

dat<-readRDS("toothfish/longline.rds")

plot_dat <- reshape2::melt(dat, "Year")
ggplot(plot_dat, aes(x = Year, y = value)) +
  geom_point() +
  facet_wrap(~variable, nrow = 2, scales = "free")


```

We can see from the data that there have been big changes in effort and catches through time. The three plots show effort in units of number of hooks, catches are in tonnes, and the final plot shows how the area of the fishing activity has expanded through time.

Previously we assumed effort was 1 and we worked with catchability as the variable. Real effort data can come in all sorts of different units (hours or days fished, kilowatt days, number of vessels all per unit time). The key to using this in our model is that the catchability is the fraction of the available (that is also selected by the gear) stock caught per unit of any effort that is included.

Often, we have used fishing mortality rates from stock assessment to drive changes in effort through time, assuming Q\*E = F at maximally selected sizes (as in [this](https://besjournals.onlinelibrary.wiley.com/doi/10.1111/1365-2664.12238) paper and others). But in many cases this information is not available. It also could be misleading as those fishing mortality rates are estimated using very different single-species models (but sometimes that is the best we have to work with, and as with all of the assumptions we make the limitations just need to be clear).

How do we incorporate the effort data into the model? First, we can express the effort as relative to the time-averaged values, that were used to set up the steady state. Then we have to re-arrange the data so it can be read into the *param* object.

```{r, code_folding=TRUE}
species_params(params)

relative_effort<-dat$EffortPerArea/mean(dat$EffortPerArea)
# side note: if time-averaged effort  is used to calibrate to steady state, it should be taken across the stable time period of the fishery

effort_time <-array(c(rep(0,53),dat$EffortPerArea), dim = c(length(1950:2020),1),dimnames = list("time" = 1950:2020, "gear" = params@gear_params$gear[1]))

```

Next we use the effort data to project the model forwards from it's steady state. But wait - we did not set up the model for the first year of the data, when fishing only just began. It may make more sense to use a steady state without fishing as the initial values for our projection.

```{r, code_folding=TRUE}
sim0 <- projectToSteady(params, effort = 0, return_sim = TRUE, t_max = 200)
params<-setInitialValues(params,sim0)


simf <- project(params, effort = effort_time)
yieldplot<-plotYieldGear(simf)
yieldcompare<-yieldplot+ geom_point(data = dat, shape = 1, size = 1, mapping = aes(x=Year, y= CatchPerArea))
yieldcompare


```

Here we can see that the modeled catch time series fall within the scatter of the observed catch data (reassuring), but the trends are different. It seems there is a sharp decline in modeled catches towards the end of the time series. While we should not expect the exact up and down fluctuations to be captured by our model (we don't have anything forcing the changes through time other than fishing!), we can examine how changing the reproduction parameters affects how well the model captures stock decline (and later, recovery), relative to the trends in the data.

We can look at this below by changing the reproduction level and seeing what the levels of sustainable fishing mortality the equilibrium yield vs F curves suggest for different assumptions (where the peak occurs we could consider a proxy for single-species *Fmsy*) .

```{r,code_folding=T}
params2<- setBevertonHolt(params, reproduction_level = 0.2)

sim02 <- projectToSteady(params2, effort = 0, return_sim = TRUE, t_max = 200)

plotYieldVsF(params2,species="D.ele")
plotYieldVsF(params,species="D.ele")
```

Next, let's compare what happens when when use these new parameter in our dynamical fishing runs.

```{r}
params2<-setInitialValues(params2,sim02)
simf2 <- project(params2, effort = effort_time)

yieldplot2<-plotYieldGear(simf2)

yieldcompare2<-yieldplot2+ geom_point(data = dat, shape = 1, size = 1, mapping = aes(x=Year, y= CatchPerArea))
yieldcompare2


```

How do you interpret this? Remember think about the relationship between the fishing parameters in the model (e.g. F = Q*E). We didn't change these parameters, so they should be the same in both simulations and we can check them below:

```{r}
plotFMort(simf)
plotFMort(simf2)
```


#### Exercise:

Examine how catch time series changes relative to the data if the reproduction parameters change. Is this consistent with what you expected from the steady state yield curves? How do the biomasses change under these different scenarios?

### Catch only exploration

What if there was no effort data only catch ?

Many fisheries develop through time according to phases: an exponential growth period, following either a peak and subsequent decline and a plateau, if stocks drop below sustainable levels and management kicks in (see [here](https://www.pnas.org/doi/abs/10.1073/pnas.1820344116) for example). These different types of development can be represented by a function, *effort_dynamics*(), and can be used to help estimate the fishing parameters given the the model parameters and data you may have. This is the approach used [here](https://www.pnas.org/doi/full/10.1073/pnas.1612722114). Here, we will use this function to explore effort through time.

```{r,code_folding=TRUE}
# move to helper_functions

effort_dynamics<-function(effort_array, gear="longline",time=1950:2020,Fmax=1.5,steepness=0.2,midpoint=2005){

effort_array[,gear]<-Fmax/(1+ exp(-steepness*(time - midpoint)))

return(effort_array)
}

neweffort<-effort_dynamics(effort_time,Fmax=2.0,steepness=0.2,midpoint=2003)

# to scale this up to the effort and catchability we used in our model we can multiply by initial effort 

neweffort<-neweffort*sim@params@initial_effort

year=1950:2020
plot(year,neweffort,typ="l")
```

#### Exercise

What level of Fmax causes collapse? Is this consistent with the knowledge form the equilibrium yield curves (sensitivity to fishing tutorial)? What do E and Q need to be to match the data?

Optional : Exercise- set up another gear or a bycatch on on other the other species - follow same effort but with a lower catchability

### Going further

If you are interested in 
