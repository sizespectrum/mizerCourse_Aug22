---
title: "Change resources"
---

## Introduction

Mizer can be used to explore the consequences of climate change scenarios on aquatic ecosystems and fisheries. One of the major responses to climate change is changing plankton abundance and size structure. However, these responses are highly uncertain and variable and so are their impacts on the rest of food webs.

We can implement multiple drivers under climate change by coupling mizer to outputs of earth system models such as temperature, abundance of different size classes of plankton and/or detrital "marine snow" that reaches the seafloor through time.

### Changes through time

In this example, we will demonstrate how to implement changes in resource abundance and size structure through time, by working with pre-made resource size spectra files (n_pp) that were estimated from two climate change scenarios from earth system model output. These were derived from model variables small and large phytoplankton biomass from the Fisheries and Marine Ecosystems Model Intercomparison Project ([FishMIP](https://www.isimip.org/about/marine-ecosystems-fisheries/)). There are a lot of steps in processing these data, but we won't go in to that here. The main goal is to demonstrate how to use these scenario forcings to create changes in your mizer resources through time.

We will combine these plankton forcings with the status quo fishing scenario we used last time to explore how the marine demersal fish community changes under this forcing through time. The two model scenarios are ssp585 (highest emissions or "worst") and ssp126 (mitigation to cut emissions or "best").

```{r,message=FALSE}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
remotes::install_github("sizespectrum/mizerHowTo")
library(mizerHowTo)
library(tidyverse)
source("helper_functions.R")
```

Read in the parameters and the climate scenario inputs for the resource spectrum.

```{r}
sim <- readRDS("sim0.RDS")
params <- sim@params
first_year <- 2021
last_year <- 2070
times <- seq(first_year,last_year, by = 1)
```

We need to create a function to enable the mizer model to use the plankton forcing from the earth system model.

```{r,code_folding=T,message=FALSE}
plankton_forcing <- function(params, t, ...) {
  w_cut_off <- 10
  pkt <- 10^(other_params(params)$n_pp_array[t + params@other_params$other$t_idx,])/params@dw_full # converting to density
  pkt[which(as.numeric(names(pkt)) >= w_cut_off)] <- 0
  return(pkt)  
}

params<- setResource(params, resource_dynamics = "plankton_forcing")


## Time index
other_params(params)$t_idx = -2020 # n_pp array starts at 2021 so any time generated by the effort array will match the rownumber of the n_pp array


```

Now, set up the two climate scenarios. These read in the pre-existing n_pp files mentioned above.

```{r,code_folding=T,message=FALSE}

params_worst<-params

params_best<-params

other_params(params_best)$n_pp_array <-readRDS("toothfish/IPSL_n_pp_array_CCscenario_126.RDS")
    
other_params(params_worst)$n_pp_array <- readRDS("toothfish/IPSL_n_pp_array_CCscenario_585.RDS")



```


Have a look how the model responds through time without fishing.

```{r,message=FALSE}

sim_ncc <- project(sim@params, effort = 0, t_start = 2021, t_max = 50)


sim_best <- project(params_best, effort = 0,t_start = 2021, t_max = 50)

sim_worst <- project(params_worst, effort = 0,t_start = 2021, t_max = 50)


plotBiomass(sim_ncc)
plotBiomass(sim_best)
plotBiomass(sim_worst)

```


```{r}
change_biomass_best <- melt(getBiomass(sim_best)-getBiomass(sim_ncc))
change_biomass_worst <- melt(getBiomass(sim_worst)-getBiomass(sim_ncc))

p1<-ggplot(change_biomass_best) +
    geom_line(aes(x = time, y = value, colour = sp))

p2<-p1 + geom_line(data= change_biomass_worst, aes(x = time, y = value, colour = sp),linetype = "dotted") + labs(y="Biomass/Biomass No CC")

p2
```


This shows how the effects of plankton changing alone through time can have a big effects in the model but that the differences in the scenarios for this region are marginal.

Next we can use the fishing effort projection from our previous tutorial.  Let's just look at the worst-case climate scenario for this.
```{r}
effort<-readRDS("sim_scen2.rds")@effort

sim_ncc_f <- project(sim@params, effort = effort, t_start = 2021, t_max = 50)


sim_worst_f <- project(params_worst, effort = effort,t_start = 2021, t_max = 50)


```

Now we can compare the combined effects of fishing + plankton under climate change to climate change alone by comparing the differences between the climate only simulations and the climate + fishing simulations to a no fishing and no climate change simulation. 

```{r}

change_biomass_worst_f <- melt(getBiomass(sim_worst_f)-getBiomass(sim_ncc)[1:50,])


p1<-ggplot(change_biomass_worst_f) +
    geom_line(aes(x = time, y = value, colour = sp))

# the dotted line is without fishing
p2<-p1 + geom_line(data= change_biomass_worst, aes(x = time, y = value, colour = sp),linetype = "dotted") + labs(y="Biomass/Biomass No CC No Fishing")

p2
```

We can see, as expected, that adding fishing on top of climate change worsens the outcome for toothfish through time. What about the effects on climate change alone relative to fished system?

```{r}
change_biomass_ncc_f <- melt(getBiomass(sim_ncc_f)-getBiomass(sim_ncc)[1:50,])

# solid line is effect of fishing alone
p1<-ggplot(change_biomass_ncc_f) +
    geom_line(aes(x = time, y = value, colour = sp))

 

p2<-p1 + geom_line(data= change_biomass_worst_f, aes(x = time, y = value, colour = sp),linetype = "dotted") + labs(y="Biomass/Biomass No CC No Fishing")

p2
```
The solid line is the effect of fishing alone. So the effects of climate change on the fished ecosystem is fairly large.


The above example shows how you can directly use outputs of earth system models for projections (GFDL inputs - FishMIP), to easily show you what functions to work we will use 2 stylised scenarios that you can adapt and explore for your own model scenarios.

This is just one part of the set up that we have used to create a thermizer model for the Patagonian toothfish fishery and for FishMIP.

### Comparing alternative states when there are multiple resources

Alternatively, even if we do not couple directly to these outputs we can create experiments that examine long-term changes in these drivers relative to a baseline steady state.

There is high uncertainty about how non-planktonic benthic or macroalgal resources will change under climate scenarios. This is the topic being addressed with Asta's Tasmanian model in this paper. You can explore these scenarios using the Rshiny app developed from that model here.



SHOW STEADY STATE CHANGING OF KAPPA AND LAMBDA?

*** Exercise: Try creating running your own scenarios - this time without fishing How do changes in resource affect the species biomass compared to when they are also fished? How do the scenarios compare?
