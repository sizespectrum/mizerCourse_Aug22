---
title: "Dynamics of size spectra"
---

## In preparation

```{r message=FALSE}
#| message: false
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
library(tidyverse)
library(plotly)
```



## Introduction

In previous tutorials we have concentrated on the steady state of the mizer model, where for each size class and each species, the rate at which individuals grow into the size class balances the rate at which individuals grow out of the size class or die, thus keeping the size spectrum constant. In this tutorial we explore the dynamic that takes place when this balance is changed.

You will be doing your own work for this tutorial in the accompanying worksheet file "worksheet5-dynamics-of-spectra.Rmd". You will find this file in the worksheet repository for this week that you already used in previous tutorials.

As always, we start by making sure we have the latest version of the mizerExperimental package and load it as well as the tidyverse.

```{r}
#| message: false
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
library(tidyverse)
```
## Size-spectrum dynamics

In the previous tutorial in the section on [trophic cascades](species-interaction.qmd#trophic-cascades) We already ran the size-spectrum dynamics to find the new steady state. But we only looked at the final outcome once the dynamics had settled down to the new steady state:

```{r}
# Create trait-based model
mp <- newTraitParams() |> 
    # run to steady state with constant reproduction rate
    steady() |>
    # turn of reproduction and instead keep egg abundance constant
    setRateFunction("RDI", "constantEggRDI") |>
    setRateFunction("RDD", "noRDD")
```

```{r}
# We make a copy of the model
mp_lessRes <- mp
# and set the resource interaction to 0.5 for species 9
species_params(mp_lessRes)$interaction_resource[8:11] <- 0.8
```

```{r}
mp_lessRes_steady <- projectToSteady(mp_lessRes)
```

```{r}
plotSpectra2(mp_lessRes_steady, "less resource", mp, "original", 
            total = TRUE, power = 2, ylim = c(1e-8, NA), wlim = c(1e-3, NA))
```

```{r}
sim_lessRes <- project(mp_lessRes, t_max = 24)
```

```{r}
animateSpectra(sim_lessRes, total = TRUE, power = 2, 
               ylim = c(1e-8, NA), wlim = c(1e-3, NA))
```


## Reproduction dynamics

The above simulation was run with constant abundance in the smallest size class for each species. This of course is not realistic. The abundance of the smallest individuals depends on the rate at which mature individuals spawn offspring, and this in turn depends, among other things, on the abundance of mature individuals. So if the abundance of mature individuals goes down drastically, as it did for species 8 to 11 above, then the abundance of offsprings will go down as well.

To see the effect we turn reproduction dynamics back on:

```{r}
# Create trait-based model
mp <- newTraitParams() |> 
    # run to steady state with constant reproduction rate
    steady()
```

```{r}
# We make a copy of the model
mp_lessRes <- mp
# and set the resource interaction to 0.5 for species 9
species_params(mp_lessRes)$interaction_resource[8:11] <- 0.8
```

```{r}
sim_lessRes <- project(mp_lessRes, t_max = 30, t_save = 2)
```

```{r}
animateSpectra(sim_lessRes, total = TRUE, power = 2, 
               ylim = c(1e-8, NA), wlim = c(1e-3, NA))
```

## Reproduction level

```{r}
getReproductionLevel(mp)
```

```{r}
mp9 <- setBevertonHolt(mp, reproduction_level = 0.9)
```


```{r}
mp9 <- steady(mp9)

plotSpectra2(mp, "reproduction_level = 0.25", mp9, "reproduction_level = 0.9", 
            total = TRUE, power = 2, ylim = c(1e-8, NA), wlim = c(1e-3, NA))
```



```{r}
# We make a copy of the model
mp_lessRes <- mp
# and set the resource interaction to 0.5 for species 9
species_params(mp_lessRes)$interaction_resource[8:11] <- 0.8

sim_lessRes <- project(mp_lessRes, t_max = 30, t_save = 2)

animateSpectra(sim_lessRes, total = TRUE, power = 2, 
               ylim = c(1e-8, NA), wlim = c(1e-3, NA))
```



## Summary and recap


